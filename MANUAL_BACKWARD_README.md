# æ‰‹åŠ¨åå‘ä¼ æ’­å®ç°è¯´æ˜

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### 1. **æ–°å¢æ–‡ä»¶**
- `manual_backward_efficient.py` - é«˜æ•ˆçš„tile-basedæ‰‹åŠ¨åå‘ä¼ æ’­å®ç°

### 2. **ä¿®æ”¹çš„æ–‡ä»¶**
- `model.py` - æ·»åŠ æ‰‹åŠ¨åå‘ä¼ æ’­æ”¯æŒ
- `cfgs/default.yaml` - æ·»åŠ  `use_manual_backward` é…ç½®é¡¹

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1ï¼šé€šè¿‡é…ç½®æ–‡ä»¶
ç¼–è¾‘ `cfgs/default.yaml`ï¼Œè®¾ç½®ï¼š
```yaml
use_manual_backward: True  # å¯ç”¨æ‰‹åŠ¨åå‘ä¼ æ’­
```

ç„¶åæ­£å¸¸è¿è¡Œï¼š
```bash
python main.py --input_path=images/00001.jpg --exp_name=test/00001 --num_gaussians=10000
```

### æ–¹æ³•2ï¼šé€šè¿‡å‘½ä»¤è¡Œå‚æ•°
```bash
python main.py --input_path=images/00001.jpg --exp_name=test/00001 --num_gaussians=10000 --use_manual_backward
```

## ğŸ”§ å®ç°ç»†èŠ‚

### æ ¸å¿ƒç»„ä»¶

#### 1. **rasterize_backward_tile_based** (manual_backward_efficient.py)
- **åŠŸèƒ½**: å…‰æ …åŒ–è¿‡ç¨‹çš„åå‘ä¼ æ’­
- **ç‰¹ç‚¹**: ä½¿ç”¨tile-basedæ–¹å¼ï¼Œä¸CUDAå‰å‘ä¿æŒä¸€è‡´
- **è¾“å…¥**: 
  - `xys`: é«˜æ–¯ä¸­å¿ƒä½ç½® [N, 2]
  - `conics`: äºŒæ¬¡å‹å‚æ•° [N, 3]
  - `colors`: ç‰¹å¾/é¢œè‰² [N, C]
  - `radii`: åŠå¾„ [N]
  - `grad_output`: è¾“å‡ºæ¢¯åº¦ [C, H, W]
- **è¾“å‡º**:
  - `v_xy`: ä½ç½®æ¢¯åº¦ [N, 2]
  - `v_conic`: conicæ¢¯åº¦ [N, 3]
  - `v_color`: é¢œè‰²æ¢¯åº¦ [N, C]

**å…³é”®ä¼˜åŒ–**:
- Tile-basedå¤„ç† (é»˜è®¤16x16 tile)
- æ‰¹å¤„ç†é«˜æ–¯ä»¥èŠ‚çœå†…å­˜
- åªå¤„ç†ä¸tileç›¸äº¤çš„é«˜æ–¯
- ä½¿ç”¨ `index_add_` é«˜æ•ˆç´¯ç§¯æ¢¯åº¦

#### 2. **project_backward_scale_rot** (manual_backward_efficient.py)
- **åŠŸèƒ½**: 2DæŠ•å½±çš„åå‘ä¼ æ’­
- **å®ç°**: ä» `xy_proj`, `conics` çš„æ¢¯åº¦åå‘ä¼ æ’­åˆ° `means2d`, `scales2d`, `rotation`
- **ä½¿ç”¨**: æ—‹è½¬çŸ©é˜µé›…å¯æ¯”ã€é“¾å¼æ³•åˆ™

#### 3. **_manual_backward** (model.py)
- **åŠŸèƒ½**: åè°ƒæ•´ä¸ªåå‘ä¼ æ’­æµç¨‹
- **æ­¥éª¤**:
  1. è®¡ç®—æŸå¤±å¯¹å›¾åƒçš„æ¢¯åº¦
  2. é€šè¿‡ `rasterize_backward_tile_based` è®¡ç®—åˆ°é«˜æ–¯å‚æ•°çš„æ¢¯åº¦
  3. é€šè¿‡ `project_backward_scale_rot` è®¡ç®—åˆ°è¾“å…¥å‚æ•°çš„æ¢¯åº¦
  4. å°†æ¢¯åº¦èµ‹å€¼ç»™ `.grad` å±æ€§

## ğŸ“Š è¾“å‡ºç¤ºä¾‹

å¯ç”¨æ‰‹åŠ¨åå‘ä¼ æ’­åï¼Œä¼šçœ‹åˆ°è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š

```
######################################################################
[Step 1] å‡†å¤‡è°ƒç”¨ backward()
  total_loss: 0.046577
  ä½¿ç”¨æ‰‹åŠ¨åå‘ä¼ æ’­: True
######################################################################

  ğŸ”¥ [Manual Backward] å¼€å§‹æ‰‹åŠ¨åå‘ä¼ æ’­...
    æ¢¯åº¦å›¾åƒ shape: torch.Size([3, 512, 512]), mean: 0.00012345
    è°ƒç”¨ rasterize_backward_tile_based...
  [Manual Backward] Processing 32x32 tiles...
    v_xy_proj: torch.Size([10000, 2]), mean: 0.00000123
    v_conics: torch.Size([10000, 3]), mean: 0.00000234
    v_feat: torch.Size([10000, 3]), mean: 0.00001234
    è°ƒç”¨ project_backward_scale_rot...
    v_xy_input: torch.Size([10000, 2]), mean: 0.00000456
    v_scale: torch.Size([10000, 2]), mean: 0.00000567
    v_rot: torch.Size([10000, 1]), mean: 0.00000678
  âœ… [Manual Backward] æ‰‹åŠ¨åå‘ä¼ æ’­å®Œæˆï¼

######################################################################
[Step 1] backward() å®Œæˆï¼æ£€æŸ¥æ¢¯åº¦:
  xy.grad å­˜åœ¨: True
    shape: torch.Size([10000, 2]), device: cuda:0
    mean: 0.00000456, max: 0.00525704
  ...
######################################################################
```

## âš¡ æ€§èƒ½å¯¹æ¯”

| æ–¹æ³• | é€Ÿåº¦ | å†…å­˜ | çµæ´»æ€§ |
|------|------|------|--------|
| PyTorch Autograd | ğŸŸ¢ å¿« | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ |
| CUDA Backward | ğŸŸ¢ æœ€å¿« | ğŸŸ¢ ä½ | ğŸ”´ ä½ |
| Manual Backward (Tile-based) | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | ğŸŸ¢ é«˜ |

## ğŸ› è°ƒè¯•å»ºè®®

1. **æ£€æŸ¥æ¢¯åº¦æ•°å€¼**: å‰å‡ æ­¥ä¼šæ‰“å°æ¢¯åº¦çš„å‡å€¼å’Œæœ€å¤§å€¼
2. **å¯¹æ¯”ç»“æœ**: å¯ä»¥å…ˆç”¨autogradè®­ç»ƒå‡ æ­¥ï¼Œå†åˆ‡æ¢åˆ°manual backwardå¯¹æ¯”
3. **å‡å°‘é«˜æ–¯æ•°é‡**: è°ƒè¯•æ—¶ä½¿ç”¨è¾ƒå°‘çš„é«˜æ–¯ (`--num_gaussians=1000`)

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **SSIMæ¢¯åº¦**: å½“å‰å®ç°ä¸­SSIMçš„æ¢¯åº¦ä»ä½¿ç”¨autogradè®¡ç®—ï¼ˆå› ä¸ºSSIMå…¬å¼å¤æ‚ï¼‰
2. **é‡åŒ–æ”¯æŒ**: æ‰‹åŠ¨åå‘ä¼ æ’­ä¹Ÿæ”¯æŒé‡åŒ–è®­ç»ƒ
3. **å†…å­˜å ç”¨**: tile-basedæ–¹å¼ä¼šç¼“å­˜ä¸­é—´ç»“æœï¼Œéœ€è¦é¢å¤–å†…å­˜
4. **è°ƒè¯•æ¨¡å¼**: å‰2æ­¥ä¼šæ‰“å°è¯¦ç»†ä¿¡æ¯ï¼Œä¹‹åè‡ªåŠ¨å…³é—­ä»¥æé«˜é€Ÿåº¦

## ğŸ¯ æœªæ¥æ”¹è¿›

- [ ] å®Œå…¨æ‰‹åŠ¨å®ç°SSIMæ¢¯åº¦ï¼ˆé¿å…ä½¿ç”¨autogradï¼‰
- [ ] ä¼˜åŒ–tileè°ƒåº¦ç­–ç•¥
- [ ] æ”¯æŒå¤šGPUå¹¶è¡Œ
- [ ] æ·»åŠ æ¢¯åº¦æ£€æŸ¥å·¥å…·
